/*
 * Copyright (c) 2015, Alexei KLENIN
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *   1. Redistributions of source code must retain the above copyright notice,
 *        this list of conditions and the following disclaimer.
 *
 *   2. Redistributions in binary form must reproduce the above copyright
 *        notice, this list of conditions and the following disclaimer in the
 *        documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */
/**
 * Plugin for smooth bouncing of Leaflet markers.
 *
 * @author Alexei KLENIN <alexey_klenin@hotmail.fr>
 */
!function(factory,window){"function"==typeof define&&define.amd?define(["leaflet"],factory):"object"==typeof exports&&(module.exports=factory(require("leaflet"))),void 0!==window&&window.L&&factory(L)}(function(L){"use strict";var regStyle=/([\w-]+): ([^;]+);/g,transform={transform:"transform",WebkitTransform:"-webkit-transform",OTransform:"-o-transform",MozTransform:"-moz-transform",msTransform:"-ms-transform"}[L.DomUtil.TRANSFORM],_bouncingMotionsCache={};function parseCssText(cssText){for(var styleDefinitions={},match=regStyle.exec(cssText);match;)styleDefinitions[match[1]]=match[2],match=regStyle.exec(cssText);return styleDefinitions}function renderCssText(styleDefinitions){var key,cssText="";for(key in styleDefinitions)cssText+=key+": "+styleDefinitions[key]+"; ";return cssText}function calculateLine(x,y,angle,length){for(var e2,xD=Math.round(x+Math.cos(angle)*(2*length)),yD=Math.round(y+Math.sin(angle)*(2*length)),dx=Math.abs(xD-x),sx=x<xD?1:-1,dy=Math.abs(yD-y),sy=y<yD?1:-1,err=(dy<dx?dx:-dy)/2,p=[],i=0;p.push([x,y]),++i!==length;)-dx<(e2=err)&&(err-=dy,x+=sx),e2<dy&&(err+=dx,y+=sy);return p}function calculateIconResizeTransforms(x,y,height,contractHeight){for(var t=[],dH=contractHeight+1;dH--;)t[dH]=" matrix3d(1,0,0,0,0,"+(height-dH)/height+",0,0,0,0,1,0,"+x+","+(y+dH)+",0,1) ";return t}function calculateSteps(height,prefix){var i,key=prefix+height,steps=[];if(_bouncingMotionsCache[key])return _bouncingMotionsCache[key];for(i=1;i<=height;)steps.push(i++);for(i=height;i--;)steps.push(i);return _bouncingMotionsCache[key]=steps}function calculateDelays(height,speed,prefix){var l,i,key=prefix+height+"_"+speed,deltas=[],delays=[],totalDelay=0;if(_bouncingMotionsCache[key])return _bouncingMotionsCache[key];for(deltas[height]=speed,deltas[0]=0,i=height;--i;)deltas[i]=Math.round(speed/(height-i));for(i=height;i--;)deltas.push(deltas[i]);for(i=0,l=deltas.length;i<l;i++)totalDelay+=deltas[i],delays.push(totalDelay);return _bouncingMotionsCache[key]=delays}L.Marker._bouncingMarkers=[],L.Marker.setBouncingOptions=function(options){L.extend(L.Marker.prototype._bouncingOptions,options)},L.Marker.getBouncingMarkers=function(){return L.Marker._bouncingMarkers},L.Marker.stopAllBouncingMarkers=function(){for(var marker;marker=L.Marker._bouncingMarkers.shift();)marker._bouncingMotion.isBouncing=!1},L.Marker._addBouncingMarker=function(marker,exclusive){exclusive||marker._bouncingOptions.exclusive?L.Marker.stopAllBouncingMarkers():L.Marker._stopEclusiveMarkerBouncing(),L.Marker._bouncingMarkers.push(marker)},L.Marker._removeBouncingMarker=function(marker){var i=L.Marker._bouncingMarkers.length;if(i)for(;i--;)if(L.Marker._bouncingMarkers[i]==marker){L.Marker._bouncingMarkers.splice(i,1);break}},L.Marker._stopEclusiveMarkerBouncing=function(){var i=L.Marker._bouncingMarkers.length;if(i)for(;i--;)L.Marker._bouncingMarkers[i]._bouncingOptions.exclusive&&(L.Marker._bouncingMarkers[i]._bouncingMotion.isBouncing=!1,L.Marker._bouncingMarkers.splice(i,1))},L.Marker.include({_bouncingOptions:{bounceHeight:15,contractHeight:12,bounceSpeed:52,contractSpeed:52,shadowAngle:-Math.PI/4,elastic:!0,exclusive:!1},setBouncingOptions:function(options){return this.hasOwnProperty("_bouncingOptions")||(this._bouncingOptions=L.extend({},L.Marker.prototype._bouncingOptions)),L.extend(this._bouncingOptions,options),this._calculateTimeline(),this._calculateTransforms(),this},isBouncing:function(){return this._bouncingMotion.isBouncing},bounce:function(){var marker=this,icon=this._icon,shadow=this._shadow,bouncingOptions=marker._bouncingOptions,motion=marker._bouncingMotion,bounceSpeed=(bouncingOptions.bounceHeight,bouncingOptions.contractHeight,bouncingOptions.bounceSpeed),shadowAngle=(bouncingOptions.contractSpeed,bouncingOptions.shadowAngle),elastic=bouncingOptions.elastic,exclusive=bouncingOptions.exclusive,moveSteps=motion.moveSteps,moveDelays=motion.moveDelays,resizeSteps=motion.resizeSteps,resizeDelays=motion.resizeDelays,nbMoveSteps=moveSteps.length,nbResizeSteps=resizeSteps.length,baseIconCssText=motion.baseIconCssText,baseShadowCssText=motion.baseShadowCssText,is3d=L.Browser.any3d,times=null;if(!motion.bouncingAnimationPlaying)return 1==arguments.length&&(times=arguments[0]),L.Marker._addBouncingMarker(marker,exclusive),motion.isBouncing=!0,motion.bouncingAnimationPlaying=!0,function move(){null!==times&&(--times||(motion.isBouncing=!1,motion.bouncingAnimationPlaying=!1));var i=nbMoveSteps;if(is3d)for(;i--;)setTimeout(makeMoveStep,moveDelays[i],moveSteps[i]);else for(;i--;)setTimeout(makeMoveStepNo3D,moveDelays[i],moveSteps[i]);setTimeout(function(){elastic&&is3d?function(){var i=nbResizeSteps;for(setTimeout(function(){motion.isBouncing||(motion.bouncingAnimationPlaying=!1)},resizeDelays[i]);i--;)setTimeout(makeResizeStep,resizeDelays[i],resizeSteps[i]);setTimeout(function(){motion.isBouncing&&move()},resizeDelays[nbResizeSteps-1])}():motion.isBouncing?setTimeout(move,bounceSpeed):motion.bouncingAnimationPlaying=!1},moveDelays[nbMoveSteps-1])}(),marker;function makeMoveStep(step){icon.style.cssText=baseIconCssText+"z-index: "+marker._zIndex+";"+transform+": "+motion.iconMoveTransforms[step],shadow&&(shadow.style.cssText=baseShadowCssText+transform+": "+motion.shadowMoveTransforms[step])}function makeMoveStepNo3D(step){icon.style.cssText=baseIconCssText+"z-index: "+marker._zIndex+";",icon.style.left=motion.iconMovePoints[step][0]+"px",icon.style.top=motion.iconMovePoints[step][1]+"px",shadow&&(shadow.style.cssText=baseShadowCssText,shadow.style.left=motion.shadowMovePoints[step][0]+"px",shadow.style.top=motion.shadowMovePoints[step][1]+"px")}function makeResizeStep(step){icon.style.cssText=baseIconCssText+"z-index: "+marker._zIndex+";"+transform+": "+motion.iconResizeTransforms[step],shadow&&null!=shadowAngle&&(shadow.style.cssText=baseShadowCssText+transform+": "+motion.shadowResizeTransforms[step])}motion.isBouncing=!0},stopBouncing:function(){return this._bouncingMotion.isBouncing=!1,L.Marker._removeBouncingMarker(this),this},toggleBouncing:function(){return this._bouncingMotion.isBouncing?this.stopBouncing():this.bounce(),this},_calculateTimeline:function(){this._bouncingMotion.moveSteps=calculateSteps(this._bouncingOptions.bounceHeight,"moveSteps_"),this._bouncingMotion.moveDelays=calculateDelays(this._bouncingOptions.bounceHeight,this._bouncingOptions.bounceSpeed,"moveDelays_"),this._bouncingOptions.elastic&&(this._bouncingMotion.resizeSteps=calculateSteps(this._bouncingOptions.contractHeight,"resizeSteps_"),this._bouncingMotion.resizeDelays=calculateDelays(this._bouncingOptions.contractHeight,this._bouncingOptions.contractSpeed,"resizeDelays_"))},_calculateTransforms:function(){if(L.Browser.any3d){if(this.options.icon.options.iconSize)var iconHeight=this.options.icon.options.iconSize[1];else iconHeight=this._iconObj.options.iconSize[1];this._bouncingMotion.iconMoveTransforms=function(x,y,bounceHeight){for(var t=[],dY=bounceHeight+1;dY--;)t[dY]=" matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,"+x+","+(y-dY)+",0,1) ";return t}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight),this._bouncingMotion.iconResizeTransforms=calculateIconResizeTransforms(this._bouncingMotion.x,this._bouncingMotion.y,iconHeight,this._bouncingOptions.contractHeight),this._shadow&&(this._bouncingMotion.shadowMoveTransforms=function(x,y,bounceHeight,angle){var t=[],dY=bounceHeight+1;if(null!=angle)var p=calculateLine(x,y,angle,bounceHeight+1);else{p=[];for(var i=0;i<=bounceHeight;i++)p[i]=[x,y]}for(;dY--;)t[dY]=" matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,"+p[dY][0]+","+p[dY][1]+",0,1) ";return t}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight,this._bouncingOptions.shadowAngle),this._bouncingMotion.shadowResizeTransforms=calculateIconResizeTransforms(this._bouncingMotion.x,this._bouncingMotion.y,this.options.icon.options.shadowSize[1],this._bouncingOptions.contractHeight))}else this._bouncingMotion.iconMovePoints=function(x,y,bounceHeight){for(var p=[],dH=bounceHeight+1;dH--;)p[dH]=[x,y-dH];return p}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight),this._bouncingMotion.shadowMovePoints=function(x,y,bounceHeight,angle){if(null!=angle)return calculateLine(x,y,angle,bounceHeight+1);for(var p=[],i=0;i<=bounceHeight;i++)p[i]=[x,y];return p}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight,this._bouncingOptions.shadowAngle)}}),L.Marker.addInitHook(function(){this._bouncingMotion={isBouncing:!1,bouncingAnimationPlaying:!1},this._calculateTimeline()});var oldSetPos=L.Marker.prototype._setPos,oldOnAdd=L.Marker.prototype.onAdd,oldSetIcon=L.Marker.prototype.setIcon,oldOn=L.Marker.prototype._on;L.Marker.prototype._setPos=function(pos){oldSetPos.call(this,pos),this._bouncingMotion.x=pos.x,this._bouncingMotion.y=pos.y,this._calculateTransforms()},L.Marker.prototype.onAdd=function(map){oldOnAdd.call(this,map);var styles=parseCssText(this._icon.style.cssText);delete styles[transform],delete styles["z-index"],styles.opacity=this.options.opacityWhenUnclustered||this.options.opacity||1,this._bouncingMotion.baseIconCssText=renderCssText(styles),this._shadow&&(delete(styles=parseCssText(this._shadow.style.cssText))[transform],delete styles.opacity,this._bouncingMotion.baseShadowCssText=renderCssText(styles)),this._bouncingMotion.bouncingAnimationPlaying=!1,this._bouncingMotion.isBouncing&&this.bounce()},L.Marker.prototype.setIcon=function(icon){oldSetIcon.call(this,icon);var styles={};this._icon&&(delete(styles=parseCssText(this._icon.style.cssText))[transform],delete styles["z-index"],styles.opacity=this.options.opacityWhenUnclustered||this.options.opacity||1),this._bouncingMotion.baseIconCssText=renderCssText(styles),this._shadow&&(delete(styles=parseCssText(this._shadow.style.cssText))[transform],delete styles.opacity,this._bouncingMotion.baseShadowCssText=renderCssText(styles))},L.Marker.prototype._on=function(type,fn,context){oldOn.call(this,type,function(event){"click"===type&&document.activeElement.blur(),fn.call(this,event)},context)}},window);
